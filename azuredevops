trigger:
  - main  # Automatically triggers the pipeline on code changes in the main branch

pool:
  vmImage: 'ubuntu-latest'  # Runs on the latest Ubuntu-based VM

stages:
  
  # Build Stage
  - stage: Build
    jobs:
    - job: Build
      steps:
        - script: echo "Building the Python application..."
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.x'  # Using Python 3.x
        - script: pip install -r requirements.txt  # Install dependencies
        - script: python -m compileall .  # Check for syntax errors

  # Test Stage
  - stage: Test
    jobs:
    - job: Test
      steps:
        - script: echo "Running tests..."
        - script: pytest tests/ --junitxml=test-results.xml  # Run tests and generate a report
        - task: PublishTestResults@2
          inputs:
            testResultsFiles: '**/test-results.xml'
            testRunTitle: 'Python Tests'

  # Deploy Stage
  - stage: Deploy
    jobs:
    - job: Deploy
      steps:
        - script: echo "Deploying application to Azure VM..."
        - task: AzureCLI@2
          inputs:
            azureSubscription: '74.224.126.9'  # Replace with your service connection
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              ssh azureuser@74.224.126.9 "cd /var/www/app && git pull origin main && systemctl restart your-app-service"
